<!DOCTYPE html>
<html>
<head>
    <title>DevOps Slot Machine</title>
    <style>
        body {
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #0f0f0f, #1e1e1e);
            font-family: Arial, sans-serif;
            color: white;
        }

        .card {
            background: #1a1a1a;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            width: 520px;
            box-shadow: 0 0 25px rgba(0, 255, 150, 0.3);
        }

        .hidden {
            display: none;
        }

        input {
            width: 90%;
            padding: 12px;
            margin: 10px 0;
            border: none;
            border-radius: 8px;
            background: #2a2a2a;
            color: white;
            font-size: 16px;
        }

        button {
            background: #00ff99;
            border: none;
            padding: 12px 25px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
        }

        button:hover {
            background: #00cc77;
        }

        .reset-btn {
            background: #ff4444;
        }

        .reset-btn:hover {
            background: #cc0000;
        }

        .logout-btn {
            background: #444;
            font-size: 14px;
            padding: 8px 15px;
        }

        .logout-btn:hover {
            background: #666;
        }

        .switch-link {
            color: #00ff99;
            cursor: pointer;
            text-decoration: underline;
            margin-top: 10px;
            display: inline-block;
        }

        #reels {
            font-size: 65px;
            letter-spacing: 15px;
            margin: 30px 0;
        }

        .spinning {
            animation: spinMotion 0.15s linear infinite;
        }

        @keyframes spinMotion {
            0%   { transform: translateY(0px); }
            25%  { transform: translateY(-10px); }
            50%  { transform: translateY(10px); }
            75%  { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        #balance {
            margin-top: 15px;
            font-size: 18px;
        }

        .stats-container {
            margin-top: 25px;
            background: #111;
            padding: 20px;
            border-radius: 12px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: #1f1f1f;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #00ff99;
        }

        .history {
            text-align: left;
            max-height: 120px;
            overflow-y: auto;
            background: #1f1f1f;
            padding: 10px;
            border-radius: 8px;
        }

        .history-item {
            margin-bottom: 6px;
            font-size: 14px;
        }

        .leaderboard {
            max-height: 300px;
            overflow-y: auto;
            text-align: left;
        }

        .leaderboard-item {
            background: #1f1f1f;
            padding: 10px;
            margin: 8px 0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
        }

        .rank {
            font-weight: bold;
            color: #00ff99;
        }

        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #1a1a1a;
            padding: 10px 20px;
            border-radius: 8px;
        }

        .error-msg {
            color: #ff4444;
            margin: 10px 0;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-btn {
            flex: 1;
            background: #2a2a2a;
        }

        .tab-btn.active {
            background: #00ff99;
            color: #000;
        }
    </style>
</head>
<body>

<!-- User Info (shown when logged in) -->
<div id="userInfo" class="user-info hidden">
    <span id="usernameDisplay"></span>
    <button class="logout-btn" onclick="logout()">Logout</button>
</div>

<!-- Login/Register Screen -->
<div id="authScreen" class="card">
    <h1>ğŸ° DevOps Slot Machine</h1>
    
    <div id="loginForm">
        <h2>Login</h2>
        <input type="text" id="loginUsername" placeholder="Username" />
        <input type="password" id="loginPassword" placeholder="Password" />
        <div id="loginError" class="error-msg"></div>
        <button onclick="login()">Login</button>
        <div class="switch-link" onclick="showRegister()">Don't have an account? Register</div>
    </div>

    <div id="registerForm" class="hidden">
        <h2>Register</h2>
        <input type="text" id="registerUsername" placeholder="Username (min 3 chars)" />
        <input type="password" id="registerPassword" placeholder="Password (min 4 chars)" />
        <div id="registerError" class="error-msg"></div>
        <button onclick="register()">Register</button>
        <div class="switch-link" onclick="showLogin()">Already have an account? Login</div>
    </div>
</div>

<!-- Game Screen -->
<div id="gameScreen" class="card hidden">
    <h1>ğŸ° DevOps Slot Machine</h1>

    <div class="tab-buttons">
        <button class="tab-btn active" onclick="showTab('game')">Game</button>
        <button class="tab-btn" onclick="showTab('leaderboard')">Leaderboard</button>
    </div>

    <!-- Game Tab -->
    <div id="gameTab">
        <div id="reels">ğŸ² ğŸ² ğŸ²</div>

        <button onclick="spin()">ğŸ¯ SPIN</button>
        <button class="reset-btn" onclick="confirmReset()">ğŸ”„ RESET</button>

        <div id="balance">ğŸ’° Balance: $100</div>
        <div id="message"></div>

        <div class="stats-container">
            <div class="stats-grid" id="statsGrid"></div>

            <h3 style="margin-bottom:8px;">ğŸ•’ Last 5 Spins</h3>
            <div class="history" id="history"></div>
        </div>
    </div>

    <!-- Leaderboard Tab -->
    <div id="leaderboardTab" class="hidden">
        <h2>ğŸ† Top Players</h2>
        <div class="leaderboard" id="leaderboardList"></div>
    </div>
</div>

<script>

let authToken = localStorage.getItem('authToken');
let currentUsername = localStorage.getItem('username');

const symbolMap = {
    "@": "ğŸ’",
    "#": "ğŸ’",
    "$": "ğŸ’°",
    "*": "â­",
    "7": "7ï¸âƒ£",
    "BAR": "ğŸŸ¥",
    "CHERRY": "ğŸ’",
    "LEMON": "ğŸ‹"
};

// Initialize
if (authToken) {
    showGameScreen();
} else {
    showAuthScreen();
}

function showAuthScreen() {
    document.getElementById('authScreen').classList.remove('hidden');
    document.getElementById('gameScreen').classList.add('hidden');
    document.getElementById('userInfo').classList.add('hidden');
}

function showGameScreen() {
    document.getElementById('authScreen').classList.add('hidden');
    document.getElementById('gameScreen').classList.remove('hidden');
    document.getElementById('userInfo').classList.remove('hidden');
    document.getElementById('usernameDisplay').textContent = `ğŸ‘¤ ${currentUsername}`;
    loadStats();
    showTab('game');
}

function showLogin() {
    document.getElementById('loginForm').classList.remove('hidden');
    document.getElementById('registerForm').classList.add('hidden');
}

function showRegister() {
    document.getElementById('loginForm').classList.add('hidden');
    document.getElementById('registerForm').classList.remove('hidden');
}

function showTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    
    if (tab === 'game') {
        document.getElementById('gameTab').classList.remove('hidden');
        document.getElementById('leaderboardTab').classList.add('hidden');
        document.querySelectorAll('.tab-btn')[0].classList.add('active');
    } else {
        document.getElementById('gameTab').classList.add('hidden');
        document.getElementById('leaderboardTab').classList.remove('hidden');
        document.querySelectorAll('.tab-btn')[1].classList.add('active');
        loadLeaderboard();
    }
}

async function register() {
    const username = document.getElementById('registerUsername').value;
    const password = document.getElementById('registerPassword').value;
    const errorDiv = document.getElementById('registerError');
    
    errorDiv.textContent = '';
    
    try {
        const response = await fetch('/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            errorDiv.textContent = data.detail;
            return;
        }
        
        authToken = data.token;
        currentUsername = data.username;
        localStorage.setItem('authToken', authToken);
        localStorage.setItem('username', currentUsername);
        
        document.getElementById('balance').textContent = `ğŸ’° Balance: $${data.balance}`;
        showGameScreen();
    } catch (error) {
        errorDiv.textContent = 'Registration failed. Please try again.';
    }
}

async function login() {
    const username = document.getElementById('loginUsername').value;
    const password = document.getElementById('loginPassword').value;
    const errorDiv = document.getElementById('loginError');
    
    errorDiv.textContent = '';
    
    try {
        const response = await fetch('/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            errorDiv.textContent = data.detail;
            return;
        }
        
        authToken = data.token;
        currentUsername = data.username;
        localStorage.setItem('authToken', authToken);
        localStorage.setItem('username', currentUsername);
        
        document.getElementById('balance').textContent = `ğŸ’° Balance: $${data.balance}`;
        showGameScreen();
    } catch (error) {
        errorDiv.textContent = 'Login failed. Please try again.';
    }
}

async function logout() {
    try {
        await fetch('/logout', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
    } catch (error) {
        console.error('Logout error:', error);
    }
    
    authToken = null;
    currentUsername = null;
    localStorage.removeItem('authToken');
    localStorage.removeItem('username');
    showAuthScreen();
}

async function spin() {
    const reels = document.getElementById("reels");
    reels.classList.add("spinning");

    let symbols = Object.values(symbolMap);

    const interval = setInterval(() => {
        reels.innerHTML =
            `${symbols[Math.floor(Math.random()*symbols.length)]}
             ${symbols[Math.floor(Math.random()*symbols.length)]}
             ${symbols[Math.floor(Math.random()*symbols.length)]}`;
    }, 100);

    try {
        const response = await fetch('/spin', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({ bet_amount: 5 })
        });

        const data = await response.json();

        await new Promise(resolve => setTimeout(resolve, 1000));

        clearInterval(interval);
        reels.classList.remove("spinning");

        if (!response.ok) {
            document.getElementById('message').innerHTML = `âš  ${data.detail}`;
            return;
        }

        reels.innerHTML =
            `${symbolMap[data.reel1]} 
             ${symbolMap[data.reel2]} 
             ${symbolMap[data.reel3]}`;

        document.getElementById('balance').innerHTML = `ğŸ’° Balance: $${data.new_balance}`;

        document.getElementById('message').innerHTML =
            data.winnings > 0
                ? `ğŸ‰ JACKPOT! You won $${data.winnings}!`
                : `ğŸ˜… No win.`;

        loadStats();
    } catch (error) {
        clearInterval(interval);
        reels.classList.remove("spinning");
        document.getElementById('message').innerHTML = 'âš  Error spinning. Please try again.';
    }
}

async function loadStats() {
    try {
        const response = await fetch('/stats', {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        const data = await response.json();

        document.getElementById('statsGrid').innerHTML = `
            <div class="stat-box">ğŸ“Š Spins<div class="stat-value">${data.total_spins}</div></div>
            <div class="stat-box">ğŸ† Wins<div class="stat-value">${data.total_wins}</div></div>
            <div class="stat-box">ğŸ’ Total Won<div class="stat-value">$${data.total_amount_won}</div></div>
            <div class="stat-box">ğŸ“ˆ Win Rate<div class="stat-value">${data.win_rate}%</div></div>
            <div class="stat-box">ğŸ”¥ Highest Win<div class="stat-value">$${data.highest_win}</div></div>
            <div class="stat-box">ğŸš€ Win Streak<div class="stat-value">${data.max_win_streak}</div></div>
        `;

        let historyHTML = data.last_5_spins.map(spin =>
            `<div class="history-item">
                ğŸ² ${spin.reels.map(r => symbolMap[r]).join(" | ")}
                â†’ ğŸ’° $${spin.winnings}
            </div>`
        ).join("");

        document.getElementById('history').innerHTML = historyHTML || '<div class="history-item">No spins yet</div>';
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

async function loadLeaderboard() {
    try {
        const response = await fetch('/leaderboard');
        const data = await response.json();

        let leaderboardHTML = data.leaderboard.map(entry =>
            `<div class="leaderboard-item">
                <span class="rank">#${entry.rank} ${entry.username}</span>
                <span>ğŸ’° $${entry.balance}</span>
            </div>`
        ).join("");

        document.getElementById('leaderboardList').innerHTML = leaderboardHTML || '<p>No players yet</p>';
    } catch (error) {
        document.getElementById('leaderboardList').innerHTML = '<p>Error loading leaderboard</p>';
    }
}

function confirmReset() {
    if (confirm('âš ï¸ Are you sure you want to RESET? This will set your balance to $100 and clear all your game history!')) {
        resetGame();
    }
}

async function resetGame() {
    try {
        const response = await fetch('/reset', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${authToken}` }
        });

        const data = await response.json();

        document.getElementById('reels').innerHTML = "ğŸ² ğŸ² ğŸ²";
        document.getElementById('balance').innerHTML = `ğŸ’° Balance: $${data.balance}`;
        document.getElementById('message').innerHTML = "âœ… Game reset!";

        loadStats();
    } catch (error) {
        document.getElementById('message').innerHTML = 'âš  Error resetting game.';
    }
}

</script>

</body>
</html>